<#@ template debug="false" hostspecific="true" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="System.Text.RegularExpressions" #>
<#@ output extension=".cs" #>
<#
    // Read ServerTestsBase.cs to extract protected methods
    var baseFilePath = Host.ResolvePath("ServerTestsBase.cs");
    var baseContent = File.ReadAllText(baseFilePath);

    // Extract protected methods using regex
    var methodPattern = @"^\s*(?:\[[\w\(\),\s=\.\""]+\]\s*)*protected\s+void\s+(\w+)\s*\(DatabaseType\s+type(?:,\s*bool\s+(\w+))?\)";
    var matches = Regex.Matches(baseContent, methodPattern, RegexOptions.Multiline);

    var methods = new List<(string name, string? boolParam, List<string> excludedDatabases)>();
    foreach (Match match in matches)
    {
        var methodName = match.Groups[1].Value;
        var boolParam = match.Groups[2].Success ? match.Groups[2].Value : null;

        // Check for [SkipDatabase(DatabaseType.X)] attributes
        var methodStart = match.Index;
        var beforeMethod = baseContent.Substring(Math.Max(0, methodStart - 500), Math.Min(500, methodStart));

        var excluded = new List<string>();
        var skipPattern = @"\[SkipDatabase\(DatabaseType\.(\w+)";
        var skipMatches = Regex.Matches(beforeMethod, skipPattern);
        foreach (Match skipMatch in skipMatches)
        {
            excluded.Add(skipMatch.Groups[1].Value);
        }

        methods.Add((methodName, boolParam, excluded));
    }

    var databases = new[] { "MicrosoftSQLServer", "MySql", "Oracle", "PostgreSql", "Sqlite" };
#>
// <auto-generated>
//     This code was generated by ServerTests.tt template.
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
//
//     To add a new test: Add a protected method to ServerTestsBase.cs
//     The T4 template will automatically generate tests for all 5 databases.
// </auto-generated>

using FAnsi;
using NUnit.Framework;

namespace FAnsiTests.Server;

<# foreach (var db in databases) { #>
internal sealed class ServerTests_<#= db #> : ServerTestsBase
{
    private const DatabaseType DbType = DatabaseType.<#= db #>;

<# foreach (var method in methods) {
    // Skip this method if this database is in the excluded list
    if (method.excludedDatabases.Contains(db)) continue;

    if (method.boolParam == null) { #>
    [Test]
    public void <#= method.name #>() => <#= method.name #>(DbType);

<# } else { #>
    [TestCase(true)]
    [TestCase(false)]
    public void <#= method.name #>(bool <#= method.boolParam #>) => <#= method.name #>(DbType, <#= method.boolParam #>);

<# } } #>
}

<# } #>
