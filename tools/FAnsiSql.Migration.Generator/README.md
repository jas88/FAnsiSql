# FAnsiSql Migration Generator

This package provides source generators that automatically inject FAnsiSql initialization code and generate type-safe wrapper methods to help with the migration from casting-based APIs to generic interfaces.

## Features

### AutoInitializationGenerator

Automatically detects which FAnsiSql database providers are referenced in your project and generates initialization code at compile time. This replaces the need for manual ModuleInitializer attributes.

**What it does:**
- Scans project references for FAnsiSql provider assemblies
- Generates a `FAnsiSqlAutoInitializer` class with a `[ModuleInitializer]` method
- Automatically registers all detected database providers
- Provides graceful fallback if providers are not available

**Generated Example:**
```csharp
// <auto-generated/>
namespace FAnsiSql.Generated
{
    using System.Runtime.CompilerServices;

    internal static class FAnsiSqlAutoInitializer
    {
        private static bool _initialized = false;

        [ModuleInitializer]
        internal static void Initialize()
        {
            if (_initialized) return;
            _initialized = true;

            // Register FAnsi.MicrosoftSql
            RegisterMicrosoftSQLServerHelper();

            // Register FAnsi.MySql
            RegisterMySqlServerHelper();

            // Initialize generic implementations if available
            InitializeGenericImplementations();
        }

        private static void RegisterMicrosoftSQLServerHelper()
        {
            try
            {
                var helper = FAnsi.Implementations.MicrosoftSQL.MicrosoftSQLServerHelper.Instance;
                System.Diagnostics.Debug.WriteLine("FAnsiSql MicrosoftSQLServerHelper initialized");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Failed to initialize MicrosoftSQLServerHelper: {ex.Message}");
            }
        }
    }
}
```

### GenericWrapperGenerator

Analyzes your code to detect IManagedConnection usage patterns and generates convenient extension methods for accessing the new generic APIs.

**What it does:**
- Detects IManagedConnection variable declarations and method calls
- Generates type-safe extension methods for each database provider
- Provides convenient conversion methods without manual casting
- Creates helper methods for common operations

**Generated Example:**
```csharp
// <auto-generated/>
namespace FAnsiSql.Generated
{
    public static class FAnsiSqlGenericExtensions
    {
        public static IManagedConnection<SqlConnection, SqlTransaction> AsSqlServer(
            this IManagedConnection connection)
        {
            return connection.AsGeneric<SqlConnection, SqlTransaction>();
        }

        public static IManagedConnection<MySqlConnection, MySqlTransaction> AsMySql(
            this IManagedConnection connection)
        {
            return connection.AsGeneric<MySqlConnection, MySqlTransaction>();
        }

        public static GenericMicrosoftSQLBulkCopy CreateGenericBulkCopy(
            this DiscoveredTable targetTable,
            IManagedConnection<SqlConnection, SqlTransaction> connection,
            System.Globalization.CultureInfo? culture = null)
        {
            return new GenericMicrosoftSQLBulkCopy(
                targetTable, connection, culture ?? System.Globalization.CultureInfo.InvariantCulture);
        }
    }
}
```

## Usage

### Installation

```xml
<PackageReference Include="FAnsiSql.Migration.Generator" Version="1.0.0-preview" />
```

### Automatic Benefits

Once installed, the package provides immediate benefits:

1. **No Manual Initialization**: FAnsiSql providers are automatically registered when your application starts
2. **Type-Safe Extensions**: Get access to convenient extension methods for working with generic APIs
3. **Zero Configuration**: Everything happens at compile-time with no runtime configuration needed

### Migration Example

**Before (Casting-based):**
```csharp
using var connection = server.GetConnection();
var sqlConn = (SqlConnection)connection.Connection;
var sqlTrans = (SqlTransaction)connection.Transaction;

var cmd = new SqlCommand("SELECT * FROM Users", sqlConn, sqlTrans);
var bulkCopy = new MicrosoftSQLBulkCopy(table, connection, CultureInfo.InvariantCulture);
```

**After (Generated Extensions):**
```csharp
using var connection = server.GetConnection().AsSqlServer();

var cmd = connection.Connection.CreateCommand();
cmd.CommandText = "SELECT * FROM Users";

var bulkCopy = table.CreateGenericBulkCopy(connection);
```

## Integration with FAnsiSql.Migration.Analyzer

This generator works best when used alongside the `FAnsiSql.Migration.Analyzer` package:

1. **Analyzer**: Detects casting patterns and suggests improvements
2. **Generator**: Provides the extension methods to implement those improvements
3. **Result**: Seamless migration to type-safe generic APIs

## Compile-Time Benefits

- **Zero Runtime Overhead**: All generation happens at compile-time
- **Type Safety**: Generated methods are fully typed and checked by the compiler
- **IDE Support**: Full IntelliSense support for generated methods
- **Debugging**: Generated code is included in debug symbols for easier debugging

## Backward Compatibility

The generated code maintains full backward compatibility:

- Existing casting-based code continues to work
- Generated extensions are additive only
- No changes to existing FAnsiSql APIs
- Gradual migration path supported

## Requirements

- **.NET Standard 2.0** or later
- **C# 9.0** or later (for source generation features)
- **FAnsiSql** provider packages (MicrosoftSql, MySql, etc.)

## Configuration

The generator works automatically without configuration. However, you can control some aspects through MSBuild properties:

```xml
<PropertyGroup>
    <!-- Disable auto-initialization generation -->
    <FAnsiSqlDisableAutoInit>true</FAnsiSqlDisableAutoInit>

    <!-- Disable generic wrapper generation -->
    <FAnsiSqlDisableGenericWrappers>true</FAnsiSqlDisableGenericWrappers>
</PropertyGroup>
```

## Troubleshooting

### Generated Code Not Visible

If generated code doesn't appear in IntelliSense:

1. Make sure the package is installed as a development dependency
2. Restart Visual Studio or reload the project
3. Check that FAnsiSql provider packages are referenced

### Compilation Errors

If you see compilation errors related to generated code:

1. Ensure all required FAnsiSql provider packages are installed
2. Check that your project targets a compatible .NET version
3. Verify that generic FAnsiSql implementations are available (if used)

### Performance Considerations

The source generators have minimal impact on compilation time:

- Incremental generation means only changed files trigger regeneration
- Generated code is simple and optimized for compilation speed
- No runtime performance impact (everything happens at compile-time)
