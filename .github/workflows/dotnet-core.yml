name: Build, test, security, and AOT

on:
  push

env:
  MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
  ACCEPT_EULA: "Y"
  MSSQL_PID: "developer"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: write
      security-events: write
    services:
      oracle:
        image: ghcr.io/gvenzl/oracle-xe:21-slim
        env:
          ORACLE_PASSWORD: oracle
        ports:
          - 1521:1521

    steps:
    - uses: actions/checkout@v5
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5
      with:
        cache: true
        cache-dependency-path: Directory.Packages.props
    - name: MS repo
      run: |
        curl -sL https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/ubuntu/22.04/mssql-server-2022 jammy main"

    - name: Cache and install database packages
      uses: awalsh128/cache-apt-pkgs-action@v1.6.0
      with:
        packages: libeatmydata1 apt-transport-https curl postgresql postgresql-contrib mssql-tools mssql-server
        version: 1.0
        execute_install_scripts: true

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: csharp
        queries: +security-and-quality

    - name: Configure and start databases
      run: |
        # Configure SQL Server
        sudo -E /opt/mssql/bin/mssql-conf -n setup accept-eula

        # Start databases
        sudo systemctl start mssql-server
        sudo systemctl start postgresql
        sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'YourStrong!Passw0rd';"
        sudo systemctl start mysql.service

        # Configure MySQL with proper authentication
        # Wait for MySQL to start first
        echo "Waiting for MySQL to start..."
        for i in {1..15}; do
          if sudo mysqladmin ping -h localhost --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/15)"
          sleep 2
        done

        # Configure MySQL to use traditional password authentication
        echo "Configuring MySQL authentication..."

        # Disable unix_socket authentication and configure native password
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YourStrong!Passw0rd';" 2>/dev/null || \
        sudo mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YourStrong!Passw0rd';" 2>/dev/null || {
          echo "Falling back to manual user creation..."
          sudo mysql -e "DROP USER IF EXISTS 'root'@'localhost';" 2>/dev/null || true
          sudo mysql -e "CREATE USER 'root'@'localhost' IDENTIFIED BY 'YourStrong!Passw0rd';" 2>/dev/null || true
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;" 2>/dev/null || true
        }

        # Ensure proper privileges and flush
        sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true

        # Verify MySQL configuration works
        if echo "SELECT 1;" | sudo mysql -u root -p'YourStrong!Passw0rd' &>/dev/null; then
          echo "MySQL authentication configuration verified"
        else
          echo "Warning: MySQL authentication test failed - attempting final configuration"
          sudo mysql -e "UPDATE mysql.user SET plugin = 'mysql_native_password' WHERE User = 'root';" 2>/dev/null || true
          sudo mysql -e "UPDATE mysql.user SET authentication_string = PASSWORD('YourStrong!Passw0rd') WHERE User = 'root';" 2>/dev/null || true
          sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
        fi

        # Wait for Oracle to start up (database can take longer than port open)
        echo "Waiting for Oracle to start..."
        for i in {1..45}; do
          # First check if port is open
          if timeout 10s bash -c "</dev/tcp/localhost/1521" 2>/dev/null; then
            # Then test actual database connection using docker exec
            if docker exec oracle_$(docker ps -q --filter "name=oracle") bash -c "echo \"SELECT 1 FROM DUAL;\" | sqlplus -L system/oracle@localhost:1521/XE" &>/dev/null; then
              echo "Oracle is ready"
              break
            fi
          fi
          echo "Waiting for Oracle... ($i/45)"
          sleep 3
        done

        # Wait for SQL Server to start up (can take 30+ seconds)
        echo "Waiting for SQL Server to start..."
        for i in {1..60}; do
          if /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$MSSQL_SA_PASSWORD" -Q "SELECT 1" &>/dev/null; then
            echo "SQL Server is ready"
            # Additional verification - test database creation
            if /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$MSSQL_SA_PASSWORD" -Q "CREATE DATABASE test_connection_verification; DROP DATABASE test_connection_verification;" &>/dev/null; then
              echo "SQL Server database creation verified"
            else
              echo "Warning: SQL Server basic connection works but database creation may have issues"
            fi
            break
          fi
          echo "Waiting for SQL Server... ($i/60)"
          sleep 3
        done

        # Replace test configuration for CI
        for proj in FAnsi.Core.Tests FAnsi.MicrosoftSql.Tests FAnsi.MySql.Tests FAnsi.PostgreSql.Tests FAnsi.Oracle.Tests FAnsi.Sqlite.Tests; do
          if [ -f "Tests/$proj/TestDatabases-github.xml" ]; then
            mv "Tests/$proj/TestDatabases-github.xml" "Tests/$proj/TestDatabases.xml"
          fi
        done

        # Verify MySQL configuration swap succeeded
        echo "Verifying MySQL test configuration..."
        for proj in FAnsi.MySql.Tests FAnsi.Core.Tests; do
          if [ ! -f "Tests/$proj/TestDatabases.xml" ]; then
            echo "ERROR: Tests/$proj/TestDatabases.xml not found after swap!"
            ls -la "Tests/$proj/" || true
            exit 1
          fi
          echo "✓ Tests/$proj/TestDatabases.xml exists"

          # Verify MySQL section contains correct password
          if grep -q "Password=YourStrong!Passw0rd" "Tests/$proj/TestDatabases.xml"; then
            echo "✓ Tests/$proj/TestDatabases.xml has correct MySQL password"
          else
            echo "ERROR: Tests/$proj/TestDatabases.xml missing correct MySQL password"
            echo "MySQL configuration:"
            grep -A 2 "DatabaseType.*MySql" "Tests/$proj/TestDatabases.xml" || echo "No MySQL config found"
            exit 1
          fi
        done
        echo "MySQL configuration verification complete"
    - name: Test
      run: dotnet test FAnsi.sln --logger "console;verbosity=minimal" --nologo -p:TestTfmsInParallel=true

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:csharp"
        upload: False
        output: sarif-results

    - name: filter-sarif
      uses: advanced-security/filter-sarif@v1
      with:
        patterns: |
          +**/*
          -**/*.g.cs
          -**/Tests/**
        input: sarif-results/csharp.sarif
        output: sarif-results/csharp.sarif

    - name: Upload SARIF
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: sarif-results/csharp.sarif

    # AOT Compatibility Tests (reuses same databases)
    - name: Test SQL Server AOT Compatibility
      if: false
      run: |
        echo "=== Building SQL Server AOT Test ==="
        dotnet publish Tests/AotCompatibility/SqlServer.AotTest/SqlServer.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/sqlserver \
          --self-contained

        echo "=== Running SQL Server AOT Test ==="
        ./aot-output/sqlserver/SqlServer.AotTest || true
      continue-on-error: true

    - name: Test MySQL AOT Compatibility
      if: false
      run: |
        echo "=== Building MySQL AOT Test ==="
        dotnet publish Tests/AotCompatibility/MySql.AotTest/MySql.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/mysql \
          --self-contained

        echo "=== Running MySQL AOT Test ==="
        ./aot-output/mysql/MySql.AotTest || true
      continue-on-error: true

    - name: Test PostgreSQL AOT Compatibility
      if: false
      run: |
        echo "=== Building PostgreSQL AOT Test ==="
        dotnet publish Tests/AotCompatibility/PostgreSql.AotTest/PostgreSql.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/postgresql \
          --self-contained

        echo "=== Running PostgreSQL AOT Test ==="
        ./aot-output/postgresql/PostgreSql.AotTest || true
      continue-on-error: true

    - name: Test Oracle AOT Compatibility
      if: false
      run: |
        echo "=== Building Oracle AOT Test ==="
        dotnet publish Tests/AotCompatibility/Oracle.AotTest/Oracle.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/oracle \
          --self-contained

        echo "=== Running Oracle AOT Test ==="
        ./aot-output/oracle/Oracle.AotTest || true
      continue-on-error: true

    - name: Test SQLite AOT Compatibility
      if: false
      run: |
        echo "=== Building SQLite AOT Test ==="
        dotnet publish Tests/AotCompatibility/Sqlite.AotTest/Sqlite.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/sqlite \
          --self-contained

        echo "=== Running SQLite AOT Test ==="
        ./aot-output/sqlite/Sqlite.AotTest || true
      continue-on-error: true

    - name: Build Comprehensive AOT Test
      if: false
      run: |
        echo "=== Building Comprehensive FAnsiSql AOT Test ==="
        dotnet publish Tests/AotCompatibility/FAnsi.AotTest/FAnsi.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/comprehensive \
          --self-contained \
          -p:PublishTrimmed=true \
          -p:PublishSingleFile=false

        echo ""
        echo "=== AOT Build Summary ==="
        ls -lh ./aot-output/comprehensive/FAnsi.AotTest
        file ./aot-output/comprehensive/FAnsi.AotTest

    - name: Run Comprehensive AOT Test
      if: false
      run: |
        echo "=== Running Comprehensive FAnsiSql AOT Test ==="
        ./aot-output/comprehensive/FAnsi.AotTest || true
        echo ""
        echo "Note: AOT tests now have proper resource namespace configuration."
      continue-on-error: true

    - name: Check for AOT warnings
      if: false
      run: |
        echo "=== Checking for AOT Analysis Warnings ==="
        dotnet build Tests/AotCompatibility/FAnsi.AotTest/FAnsi.AotTest.csproj \
          -c Release \
          -p:PublishAot=true \
          -v detailed 2>&1 | tee build.log

        if grep -i "warning IL" build.log; then
          echo "⚠️  Found AOT/Trim warnings - review required"
        else
          echo "✅ No AOT/Trim warnings found"
        fi

    - name: Pack
      run: |
        dotnet pack FAnsi.sln -c Release -p:DebugType=full -p:SymbolPackageFormat=snupkg --include-symbols --nologo -p:Version=$(fgrep AssemblyInformationalVersion SharedAssemblyInfo.cs|cut -d'"' -f2) -o .
    - name: Nuget push
      if: contains(github.ref,'refs/tags/')
      run: dotnet nuget push FAnsi*.nupkg -s https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_API_KEY }} --skip-duplicate
    - name: Store created nupkg files
      uses: actions/upload-artifact@v5
      with:
        path: '*.nupkg'
        retention-days: 1
    - name: Upload release binaries
      if: contains(github.ref,'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref }}
        file: '*.nupkg'
        file_glob: true
        overwrite: true
