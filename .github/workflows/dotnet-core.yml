name: Build, test, security, and AOT

on:
  push

env:
  MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
  ACCEPT_EULA: "Y"
  MSSQL_PID: "developer"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: write
      security-events: write
    services:
      oracle:
        image: ghcr.io/gvenzl/oracle-xe:21-slim
        env:
          ORACLE_PASSWORD: oracle
        ports:
          - 1521:1521

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Replace test configuration for CI
      run: mv tests/FAnsiTests/TestDatabases{-github,}.xml

    - name: MS repo
      run: |
        curl -sL https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/ubuntu/22.04/mssql-server-2022 jammy main"

    - name: Cache and install database packages
      uses: awalsh128/cache-apt-pkgs-action@v1.6.0
      with:
        packages: libeatmydata1 apt-transport-https curl postgresql postgresql-contrib mssql-tools mssql-server
        version: 1.0
        execute_install_scripts: true

    - name: Configure and start databases
      run: |
        # Configure SQL Server
        sudo -E /opt/mssql/bin/mssql-conf -n setup accept-eula

        # Start databases
        sudo systemctl start postgresql
        sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'pgpass4291';"
        echo -e "[mysqld]\nlocal_infile=1" | sudo tee /etc/mysql/mysql.conf.d/local_infile.cnf
        sudo systemctl start mysql.service

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json
        cache: true
        cache-dependency-path: Directory.Packages.props

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: csharp
        queries: +security-and-quality

    - name: Build
      run: dotnet build FAnsi.sln -c Release --nologo

    - name: Install ReSharper CLI
      run: dotnet tool install -g JetBrains.ReSharper.GlobalTools

    - name: Run ReSharper InspectCode
      run: |
        jb inspectcode FAnsi.sln \
          --output=resharper-report.sarif \
          --severity=WARNING \
          --no-build \
          --exclude="**/obj/**;**/bin/**;**/*.g.cs;**/*.Designer.cs"

    - name: Wait for Oracle database
      run: |
        # Wait for Oracle to be fully ready (container reports healthy but may not accept connections yet)
        echo "Waiting for Oracle to accept connections..."
        for i in {1..30}; do
          if timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/1521' 2>/dev/null; then
            echo "Oracle is accepting connections"
            sleep 5  # Give it a few more seconds to fully initialize
            break
          fi
          echo "Attempt $i: Oracle not ready yet, waiting..."
          sleep 2
        done

    - name: Test
      run: |
        dotnet test --solution FAnsi.sln -c Release \
          --no-build \
          --coverage --coverage-output-format cobertura

    - name: Collect coverage files
      run: |
        # MTP outputs coverage to bin/<config>/<tfm>/TestResults/<guid>.cobertura.xml
        mkdir -p coverage
        find . -path "*/TestResults/*.cobertura.xml" -exec cp {} coverage/ \;
        echo "=== Coverage files collected ==="
        ls -la coverage/ || echo "No coverage files found"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/*.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:csharp"
        upload: False
        output: sarif-results

    - name: filter-sarif
      uses: advanced-security/filter-sarif@v1
      with:
        patterns: |
          +**/*
          -**/*.g.cs
          -**/tests/**
        input: sarif-results/csharp.sarif
        output: sarif-results/csharp.sarif

    - name: Upload SARIF
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: sarif-results/csharp.sarif

    - name: Upload ReSharper SARIF
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: resharper-report.sarif
        category: resharper

    # AOT Compatibility Tests (reuses same databases)
    - name: Test SQL Server AOT Compatibility
      if: false
      run: |
        echo "=== Building SQL Server AOT Test ==="
        dotnet publish tests/AotCompatibility/SqlServer.AotTest/SqlServer.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/sqlserver \
          --self-contained

        echo "=== Running SQL Server AOT Test ==="
        ./aot-output/sqlserver/SqlServer.AotTest || true
      continue-on-error: true

    - name: Test MySQL AOT Compatibility
      if: false
      run: |
        echo "=== Building MySQL AOT Test ==="
        dotnet publish tests/AotCompatibility/MySql.AotTest/MySql.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/mysql \
          --self-contained

        echo "=== Running MySQL AOT Test ==="
        ./aot-output/mysql/MySql.AotTest || true
      continue-on-error: true

    - name: Test PostgreSQL AOT Compatibility
      if: false
      run: |
        echo "=== Building PostgreSQL AOT Test ==="
        dotnet publish tests/AotCompatibility/PostgreSql.AotTest/PostgreSql.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/postgresql \
          --self-contained

        echo "=== Running PostgreSQL AOT Test ==="
        ./aot-output/postgresql/PostgreSql.AotTest || true
      continue-on-error: true

    - name: Test Oracle AOT Compatibility
      if: false
      run: |
        echo "=== Building Oracle AOT Test ==="
        dotnet publish tests/AotCompatibility/Oracle.AotTest/Oracle.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/oracle \
          --self-contained

        echo "=== Running Oracle AOT Test ==="
        ./aot-output/oracle/Oracle.AotTest || true
      continue-on-error: true

    - name: Test SQLite AOT Compatibility
      if: false
      run: |
        echo "=== Building SQLite AOT Test ==="
        dotnet publish tests/AotCompatibility/Sqlite.AotTest/Sqlite.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/sqlite \
          --self-contained

        echo "=== Running SQLite AOT Test ==="
        ./aot-output/sqlite/Sqlite.AotTest || true
      continue-on-error: true

    - name: Build Comprehensive AOT Test
      if: false
      run: |
        echo "=== Building Comprehensive FAnsiSql AOT Test ==="
        dotnet publish tests/AotCompatibility/FAnsi.AotTest/FAnsi.AotTest.csproj \
          -c Release \
          -r linux-x64 \
          -o ./aot-output/comprehensive \
          --self-contained \
          -p:PublishTrimmed=true \
          -p:PublishSingleFile=false

        echo ""
        echo "=== AOT Build Summary ==="
        ls -lh ./aot-output/comprehensive/FAnsi.AotTest
        file ./aot-output/comprehensive/FAnsi.AotTest

    - name: Run Comprehensive AOT Test
      if: false
      run: |
        echo "=== Running Comprehensive FAnsiSql AOT Test ==="
        ./aot-output/comprehensive/FAnsi.AotTest || true
        echo ""
        echo "Note: AOT tests now have proper resource namespace configuration."
      continue-on-error: true

    - name: Check for AOT warnings
      if: false
      run: |
        echo "=== Checking for AOT Analysis Warnings ==="
        dotnet build tests/AotCompatibility/FAnsi.AotTest/FAnsi.AotTest.csproj \
          -c Release \
          -p:PublishAot=true \
          -v detailed 2>&1 | tee build.log

        if grep -i "warning IL" build.log; then
          echo "⚠️  Found AOT/Trim warnings - review required"
        else
          echo "✅ No AOT/Trim warnings found"
        fi

    - name: Pack
      run: dotnet pack FAnsi.sln -c Release -p:DebugType=full -p:SymbolPackageFormat=snupkg --include-symbols --nologo -o .
    - name: Nuget push
      if: contains(github.ref,'refs/tags/')
      run: dotnet nuget push FAnsi*.nupkg -s https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_API_KEY }} --skip-duplicate
    - name: Store created nupkg files
      uses: actions/upload-artifact@v6
      with:
        path: '*.nupkg'
        retention-days: 1
    - name: Upload release binaries
      if: contains(github.ref,'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref }}
        file: '*.nupkg'
        file_glob: true
        overwrite: true
